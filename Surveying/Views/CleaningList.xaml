<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:syncfusion="clr-namespace:Syncfusion.Maui.DataGrid;assembly=Syncfusion.Maui.DataGrid"
             xmlns:pager="clr-namespace:Syncfusion.Maui.DataGrid.DataPager;assembly=Syncfusion.Maui.DataGrid"
             xmlns:helpers="clr-namespace:Surveying.Helpers"
             xmlns:local="clr-namespace:Surveying.ViewModels"
             x:Class="Surveying.Views.CleaningList"
             Title="Cleaning List">

    <ContentPage.Resources>
        <ResourceDictionary>
            <helpers:InverseBoolConverter x:Key="InverseBoolConverter" />
            <helpers:ZeroToVisibilityConverter x:Key="ZeroToVisibilityConverter" />
            <helpers:PaginatedRowNumberConverter x:Key="PaginatedRowNumberConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Header -->
        <Border Grid.Row="0" 
                BackgroundColor="#F8F9FA"
                Padding="15,12"
                Margin="0,0,0,2">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <StackLayout Grid.Column="0" Orientation="Horizontal" Spacing="12">
                    <Label Text="Containers Requiring Washing" 
                           FontSize="18" 
                           FontAttributes="Bold"
                           VerticalOptions="Center"
                           TextColor="#212529" />
                    <Border BackgroundColor="#007BFF" 
                            Padding="8,3" 
                            StrokeShape="RoundRectangle 12"
                            StrokeThickness="0"
                            VerticalOptions="Center">
                        <Label Text="{Binding TotalContainers}" 
                               TextColor="White" 
                               FontSize="12"
                               FontAttributes="Bold" />
                    </Border>
                </StackLayout>

                <ActivityIndicator Grid.Column="1"
                                 IsRunning="{Binding IsLoading}"
                                 IsVisible="{Binding IsLoading}"
                                 Color="#007BFF"
                                 WidthRequest="24"
                                 HeightRequest="24"
                                 Margin="15,0" />

                <Button Grid.Column="2"
                        Text="↻"
                        Command="{Binding RefreshCommand}"
                        FontSize="18"
                        WidthRequest="44"
                        HeightRequest="36"
                        BackgroundColor="#6C757D"
                        TextColor="White"
                        CornerRadius="8"
                        Padding="0" />
            </Grid>
        </Border>

        <!-- Search Bar -->
        <Border Grid.Row="1" 
                BackgroundColor="White"
                Padding="15,10"
                Margin="0,0,0,2">
            <SearchBar x:Name="searchBar"
                       Placeholder="Search by container, customer..."
                       Text="{Binding SearchText, Mode=TwoWay}"
                       SearchCommand="{Binding SearchCommand}"
                       HorizontalOptions="FillAndExpand"
                       BackgroundColor="White" />
        </Border>

        <!-- Loading Message -->
        <StackLayout Grid.Row="2" 
                     IsVisible="{Binding IsLoading}" 
                     Padding="20,10"
                     HorizontalOptions="Center">
            <Label Text="Loading cleaning data from API..." 
                   HorizontalTextAlignment="Center"
                   TextColor="#6C757D"
                   FontSize="14" />
        </StackLayout>

        <!-- Error Message -->
        <Border Grid.Row="2" 
               IsVisible="{Binding HasError}"
               BackgroundColor="#FFF3CD"
               Stroke="#FFEAA7"
               StrokeThickness="1"
               Margin="15,10"
               Padding="15"
               StrokeShape="RoundRectangle 8">
            <StackLayout Spacing="10">
                <Label Text="⚠️ Unable to Load Data" 
                       FontAttributes="Bold"
                       TextColor="#856404"
                       FontSize="14" />
                <Label Text="{Binding ErrorMessage}" 
                       TextColor="#856404"
                       FontSize="13"
                       LineBreakMode="WordWrap" />
                <Button Text="Retry" 
                        Command="{Binding RetryCommand}"
                        BackgroundColor="#FFC107"
                        TextColor="#212529"
                        WidthRequest="100"
                        HeightRequest="36"
                        HorizontalOptions="Center"
                        CornerRadius="6"
                        FontSize="14"
                        FontAttributes="Bold" />
            </StackLayout>
        </Border>

        <!-- Data Grid with Pagination (RESTORED) -->
        <Grid Grid.Row="3">
            <Grid.RowDefinitions>
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <!-- Data Pager -->
            <pager:SfDataPager x:Name="dataPager"
                               Grid.Row="1"
                               PageSize="10"
                               NumericButtonCount="5"
                               DisplayMode="PreviousNextNumeric"
                               Source="{Binding FilteredCleaningList}"
                               HorizontalOptions="Center"
                               Margin="10"
                               BackgroundColor="Transparent"
                               IsVisible="{Binding HasError, Converter={StaticResource InverseBoolConverter}}" />

            <!-- Data Grid -->
            <syncfusion:SfDataGrid x:Name="cleaningDataGrid"
                                   Grid.Row="0"
                                   ItemsSource="{Binding Source={x:Reference dataPager}, Path=PagedSource}"
                                   AutoGenerateColumnsMode="None"
                                   ColumnWidthMode="Auto"
                                   SelectionMode="Single"
                                   RowHeight="58"
                                   HeaderRowHeight="48"
                                   GridLinesVisibility="Horizontal"
                                   SortingMode="Single"
                                   Margin="10"
                                   IsVisible="{Binding HasError, Converter={StaticResource InverseBoolConverter}}">

                <syncfusion:SfDataGrid.Columns>
                    <!-- Row Number Column with Pagination -->
                    <syncfusion:DataGridTemplateColumn HeaderText="#" Width="60">
                        <syncfusion:DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Label Text="{Binding ., Converter={StaticResource PaginatedRowNumberConverter}, ConverterParameter={Binding Source={x:Reference dataPager}, Path=PagedSource}}"
                                       HorizontalTextAlignment="Center"
                                       VerticalTextAlignment="Center"
                                       FontSize="12"
                                       FontAttributes="Bold"
                                       TextColor="#6C757D" />
                            </DataTemplate>
                        </syncfusion:DataGridTemplateColumn.CellTemplate>
                    </syncfusion:DataGridTemplateColumn>

                    <syncfusion:DataGridTextColumn HeaderText="Container" 
                                             MappingName="ContNumber"
                                             Width="140" />

                    <syncfusion:DataGridTextColumn HeaderText="Customer" 
                                             MappingName="CustomerCode"
                                             Width="100" />

                    <syncfusion:DataGridTextColumn HeaderText="Entry Date" 
                                             MappingName="DtmIn" 
                                             Format="dd/MM/yyyy"
                                             Width="110" />

                    <syncfusion:DataGridTemplateColumn HeaderText="Status" Width="100">
                        <syncfusion:DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Border Padding="8,4" 
                                    BackgroundColor="#FFC107"
                                    StrokeShape="RoundRectangle 4,4,4,4"
                                    StrokeThickness="0"
                                    HorizontalOptions="Center"
                                    VerticalOptions="Center">
                                    <Label Text="Pending" 
                                       TextColor="White" 
                                       FontSize="12"
                                       FontAttributes="Bold"
                                       HorizontalOptions="Center"
                                       VerticalOptions="Center" />
                                </Border>
                            </DataTemplate>
                        </syncfusion:DataGridTemplateColumn.CellTemplate>
                    </syncfusion:DataGridTemplateColumn>

                    <syncfusion:DataGridTemplateColumn HeaderText="Cleaning Required" Width="130">
                        <syncfusion:DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Label Text="YXT • 1101 • APNN" 
                                   HorizontalTextAlignment="Center"
                                   VerticalTextAlignment="Center"
                                   FontSize="11"
                                   TextColor="#007BFF"
                                   FontAttributes="Bold" />
                            </DataTemplate>
                        </syncfusion:DataGridTemplateColumn.CellTemplate>
                    </syncfusion:DataGridTemplateColumn>

                    <syncfusion:DataGridTemplateColumn HeaderText="Action" Width="120">
                        <syncfusion:DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Button Text="Go to Cleaning" 
                                    BackgroundColor="#28A745"
                                    TextColor="White"
                                    FontSize="11"
                                    FontAttributes="Bold"
                                    CornerRadius="6"
                                    HeightRequest="36"
                                    Margin="5,2"
                                    Clicked="OnGoToCleaningClicked"
                                    CommandParameter="{Binding .}" />
                            </DataTemplate>
                        </syncfusion:DataGridTemplateColumn.CellTemplate>
                    </syncfusion:DataGridTemplateColumn>
                </syncfusion:SfDataGrid.Columns>
            </syncfusion:SfDataGrid>
        </Grid>

        <!-- Footer -->
        <Border Grid.Row="4" 
                BackgroundColor="#F8F9FA"
                Padding="15,10"
                Margin="0,2,0,0"
                IsVisible="{Binding HasError, Converter={StaticResource InverseBoolConverter}}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <Label Grid.Column="0"
                       Text="Filtered by cleaning criteria: YXT • 1101 • APNN"
                       FontSize="12"
                       TextColor="#6C757D"
                       VerticalOptions="Center" />

                <Label Grid.Column="1"
                       Text="{Binding FilteredCleaningList.Count, StringFormat='Showing {0} containers'}"
                       FontSize="12"
                       TextColor="#6C757D"
                       VerticalOptions="Center" />
            </Grid>
        </Border>

    </Grid>
</ContentPage>