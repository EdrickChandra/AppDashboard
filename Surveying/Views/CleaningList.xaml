<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:syncfusion="clr-namespace:Syncfusion.Maui.DataGrid;assembly=Syncfusion.Maui.DataGrid"
             xmlns:helpers="clr-namespace:Surveying.Helpers"
             xmlns:local="clr-namespace:Surveying.ViewModels"
             x:Class="Surveying.Views.CleaningList"
             Title="Cleaning List">

    <ContentPage.BindingContext>
        <local:CleaningListViewModel />
    </ContentPage.BindingContext>

    <ContentPage.Resources>
        <ResourceDictionary>
            <helpers:InverseBoolConverter x:Key="InverseBoolConverter" />
            <helpers:ZeroToVisibilityConverter x:Key="ZeroToVisibilityConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Header -->
        <Border Grid.Row="0" 
                BackgroundColor="#F8F9FA"
                Padding="15,12"
                Margin="0,0,0,2">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <StackLayout Grid.Column="0" Orientation="Horizontal" Spacing="12">
                    <Label Text="Containers Requiring Washing" 
                           FontSize="18" 
                           FontAttributes="Bold"
                           VerticalOptions="Center"
                           TextColor="#212529" />
                    <Border BackgroundColor="#007BFF" 
                            Padding="8,3" 
                            StrokeShape="RoundRectangle 12"
                            StrokeThickness="0"
                            VerticalOptions="Center">
                        <Label Text="{Binding TotalContainers}" 
                               TextColor="White" 
                               FontSize="12"
                               FontAttributes="Bold" />
                    </Border>
                </StackLayout>

                <ActivityIndicator Grid.Column="1"
                                 IsRunning="{Binding IsLoading}"
                                 IsVisible="{Binding IsLoading}"
                                 Color="#007BFF"
                                 WidthRequest="24"
                                 HeightRequest="24"
                                 Margin="15,0" />

                <Button Grid.Column="2"
                        Text="↻"
                        Command="{Binding RefreshCommand}"
                        FontSize="18"
                        WidthRequest="44"
                        HeightRequest="36"
                        BackgroundColor="#6C757D"
                        TextColor="White"
                        CornerRadius="8"
                        Padding="0" />
            </Grid>
        </Border>

        <!-- Loading Message -->
        <StackLayout Grid.Row="1" 
                     IsVisible="{Binding IsLoading}" 
                     Padding="20,10"
                     HorizontalOptions="Center">
            <Label Text="Loading cleaning data from API..." 
                   HorizontalTextAlignment="Center"
                   TextColor="#6C757D"
                   FontSize="14" />
        </StackLayout>

        <!-- Error Message -->
        <Border Grid.Row="1" 
               IsVisible="{Binding HasError}"
               BackgroundColor="#FFF3CD"
               Stroke="#FFEAA7"
               StrokeThickness="1"
               Margin="15,10"
               Padding="15"
               StrokeShape="RoundRectangle 8">
            <StackLayout Spacing="10">
                <Label Text="⚠️ Unable to Load Data" 
                       FontAttributes="Bold"
                       TextColor="#856404"
                       FontSize="14" />
                <Label Text="{Binding ErrorMessage}" 
                       TextColor="#856404"
                       FontSize="13"
                       LineBreakMode="WordWrap" />
                <Button Text="Retry" 
                        Command="{Binding RetryCommand}"
                        BackgroundColor="#FFC107"
                        TextColor="#212529"
                        WidthRequest="100"
                        HeightRequest="36"
                        HorizontalOptions="Center"
                        CornerRadius="6"
                        FontSize="14"
                        FontAttributes="Bold" />
            </StackLayout>
        </Border>

        <!-- Data Grid -->
        <syncfusion:SfDataGrid Grid.Row="2"
                               ItemsSource="{Binding CleaningList}"
                               AutoGenerateColumnsMode="None"
                               ColumnWidthMode="Auto"
                               SelectionMode="Single"
                               RowHeight="58"
                               HeaderRowHeight="48"
                               GridLinesVisibility="Horizontal"
                               SortingMode="Single"
                               Margin="0"
                               IsVisible="{Binding HasError, Converter={StaticResource InverseBoolConverter}}">

            <syncfusion:SfDataGrid.Columns>
                <syncfusion:DataGridTextColumn HeaderText="Container" 
                                             MappingName="ContNumber"
                                             Width="140" />

                <syncfusion:DataGridTextColumn HeaderText="Customer" 
                                             MappingName="CustomerCode"
                                             Width="100" />

                <syncfusion:DataGridTextColumn HeaderText="Entry Date" 
                                             MappingName="DtmIn" 
                                             Format="dd/MM/yyyy"
                                             Width="110" />

                <syncfusion:DataGridTextColumn HeaderText="Approved By" 
                                             MappingName="ApprovedBy" 
                                             Width="130" />

                <syncfusion:DataGridTemplateColumn HeaderText="Repair Codes" 
                                                 Width="110">
                    <syncfusion:DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <Label Text="{Binding RepairCodes.Count, StringFormat='{0} codes'}" 
                                   HorizontalTextAlignment="Center"
                                   VerticalTextAlignment="Center"
                                   FontSize="12"
                                   TextColor="#007BFF" />
                        </DataTemplate>
                    </syncfusion:DataGridTemplateColumn.CellTemplate>
                </syncfusion:DataGridTemplateColumn>
            </syncfusion:SfDataGrid.Columns>
        </syncfusion:SfDataGrid>

        <!-- Footer -->
        <Border Grid.Row="3" 
                BackgroundColor="#F8F9FA"
                Padding="15,10"
                Margin="0,2,0,0"
                IsVisible="{Binding HasError, Converter={StaticResource InverseBoolConverter}}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <Label Grid.Column="0"
                       Text="Filtered by repair codes: YXT • 1101 • APNN"
                       FontSize="12"
                       TextColor="#6C757D"
                       VerticalOptions="Center" />

                <Label Grid.Column="1"
                       Text="{Binding CleaningList.Count, StringFormat='Showing {0} containers'}"
                       FontSize="12"
                       TextColor="#6C757D"
                       VerticalOptions="Center" />
            </Grid>
        </Border>

    </Grid>
</ContentPage>